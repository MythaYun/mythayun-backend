# MythaYun Backend API - Documentation Compl√®te

## üìã Table des Mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Architecture technique](#architecture-technique)
3. [Fonctionnalit√©s impl√©ment√©es](#fonctionnalit√©s-impl√©ment√©es)
4. [Installation et configuration locale](#installation-et-configuration-locale)
5. [Endpoints API](#endpoints-api)
6. [Base de donn√©es](#base-de-donn√©es)
7. [D√©ploiement en production](#d√©ploiement-en-production)
8. [Tests et validation](#tests-et-validation)
9. [Maintenance et monitoring](#maintenance-et-monitoring)

---

## üéØ Vue d'ensemble

**MythaYun Backend** est une API REST moderne d√©velopp√©e avec AdonisJS v6 et TypeScript, con√ßue pour alimenter l'application mobile de football en temps r√©el MythaYun.

### Informations g√©n√©rales
- **Framework** : AdonisJS v6 avec TypeScript
- **Base de donn√©es** : PostgreSQL (Railway)
- **D√©ploiement** : Railway (Production & Staging)
- **API Football** : RapidAPI Football API v3
- **Authentification** : JWT (JSON Web Tokens)
- **Repository** : [MythaYun/mythayun-backend](https://github.com/MythaYun/mythayun-backend)

### URLs de d√©ploiement
- **Production** : `https://mythayun-backend-production.up.railway.app`
- **Staging** : `https://mythayun-backend-staging.up.railway.app` (√† configurer)
- **Health Check** : `https://mythayun-backend-production.up.railway.app/health`

---

## üèóÔ∏è Architecture technique

### Stack technologique
```
Frontend (Next.js) ‚Üî Backend API (AdonisJS) ‚Üî PostgreSQL (Railway)
                                    ‚Üï
                            RapidAPI Football API
```

### Structure du projet
```
mythayun-backend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ controllers/          # Contr√¥leurs API
‚îÇ   ‚îú‚îÄ‚îÄ models/              # Mod√®les de donn√©es
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Services m√©tier
‚îÇ   ‚îî‚îÄ‚îÄ middleware/          # Middlewares d'authentification
‚îú‚îÄ‚îÄ config/                  # Configuration (DB, app, etc.)
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ migrations/          # Migrations de base de donn√©es
‚îú‚îÄ‚îÄ start/                   # Configuration des routes et environnement
‚îî‚îÄ‚îÄ .env                     # Variables d'environnement
```

### S√©curit√©
- **Authentification JWT** avec tokens d'acc√®s (24h) et de rafra√Æchissement (7j)
- **Validation des donn√©es** avec VineJS
- **Protection CORS** configur√©e
- **Variables d'environnement** s√©curis√©es
- **Connexions SSL** pour PostgreSQL en production

---

## ‚ú® Fonctionnalit√©s impl√©ment√©es

### üîê Authentification
- **Inscription utilisateur** avec validation email/mot de passe
- **Connexion utilisateur** avec g√©n√©ration de tokens JWT
- **Rafra√Æchissement de tokens** automatique
- **D√©connexion** s√©curis√©e
- **Gestion de profil** utilisateur

### ‚öΩ Donn√©es de football
- **Matchs en temps r√©el** des 5 grandes ligues europ√©ennes
- **Fixtures** avec dates et statuts des matchs
- **√âquipes et ligues** avec logos et informations
- **Statistiques de matchs** avanc√©es
- **√âv√©nements de matchs** (buts, cartons, etc.)

### üë• Syst√®me de follows
- **Suivre/Ne plus suivre** des √©quipes, ligues, et matchs
- **Pr√©f√©rences de notifications** granulaires
- **Statistiques de follows** par utilisateur
- **Recommandations** bas√©es sur l'activit√©
- **Op√©rations en masse** pour l'onboarding

### üèüÔ∏è Guides de stades
- **Informations d√©taill√©es** sur les stades
- **Capacit√© et localisation**
- **Int√©gration** avec les donn√©es de matchs

### üìä API de sant√©
- **Monitoring** de l'√©tat du service
- **V√©rification** de la connexion √† l'API Football
- **Timestamps** pour le debugging

---

## üõ†Ô∏è Installation et configuration locale

### Pr√©requis
```bash
# Versions requises
Node.js >= 18.0.0
npm >= 8.0.0
PostgreSQL >= 13.0
Git
```

### 1. Cloner le repository
```bash
git clone https://github.com/MythaYun/mythayun-backend.git
cd mythayun-backend
```

### 2. Installer les d√©pendances
```bash
npm install
```

### 3. Configuration de l'environnement
Cr√©er un fichier `.env` √† la racine du projet :

```env
# Application
NODE_ENV=development
PORT=3333
HOST=0.0.0.0
LOG_LEVEL=debug

# S√©curit√©
APP_KEY=votre_cl√©_app_32_caract√®res
JWT_SECRET=votre_secret_jwt_32_caract√®res
JWT_EXPIRES_IN=24h
REFRESH_TOKEN_EXPIRES_IN=7d

# Base de donn√©es PostgreSQL
DB_CONNECTION=postgres
DB_HOST=localhost
DB_PORT=5432
DB_USER=votre_utilisateur
DB_PASSWORD=votre_mot_de_passe
DB_DATABASE=mythayun_dev

# API Football (RapidAPI)
RAPIDAPI_KEY=votre_cl√©_rapidapi
RAPIDAPI_HOST=api-football-v1.p.rapidapi.com
AF_SEASON=2025
AF_LEAGUE_SLUGS=39,140,78,135,61

# Configuration
MOCK_API=false
SESSION_DRIVER=cookie
```

### 4. Configuration de la base de donn√©es
```bash
# Cr√©er la base de donn√©es PostgreSQL
createdb mythayun_dev

# Ex√©cuter les migrations
node ace migration:run

# (Optionnel) Ajouter des donn√©es de test
node ace db:seed
```

### 5. D√©marrer le serveur de d√©veloppement
```bash
# Mode d√©veloppement avec rechargement automatique
npm run dev

# Ou mode production
npm run build
npm start
```

### 6. V√©rifier l'installation
```bash
# Test de l'API de sant√©
curl http://localhost:3333/health

# R√©ponse attendue :
# {"status":"ok","timestamp":"2025-08-28T...","services":{"api":"healthy","footballApi":"healthy"}}
```

---

## üåê Endpoints API

### Base URL
- **Local** : `http://localhost:3333`
- **Production** : `https://mythayun-backend-production.up.railway.app`

### üìä Sant√© et monitoring

#### `GET /health`
V√©rification de l'√©tat du service et de l'API Football.

**R√©ponse :**
```json
{
  "status": "ok",
  "timestamp": "2025-08-28T12:00:00.000Z",
  "services": {
    "api": "healthy",
    "footballApi": "healthy"
  }
}
```

### üîê Authentification

#### `POST /auth/register`
Inscription d'un nouvel utilisateur.

**Body :**
```json
{
  "fullName": "John Doe",
  "email": "john@example.com",
  "password": "motdepasse123"
}
```

**R√©ponse :**
```json
{
  "message": "User registered successfully",
  "user": {
    "id": "uuid",
    "fullName": "John Doe",
    "email": "john@example.com",
    "authProvider": "email",
    "emailVerified": false
  },
  "tokens": {
    "accessToken": "jwt_token",
    "refreshToken": "refresh_token",
    "expiresIn": 86400,
    "tokenType": "Bearer"
  }
}
```

#### `POST /auth/login`
Connexion utilisateur.

**Body :**
```json
{
  "email": "john@example.com",
  "password": "motdepasse123"
}
```

**R√©ponse :** Identique √† l'inscription.

#### `GET /api/v1/profile`
R√©cup√©ration du profil utilisateur (authentification requise).

**Headers :**
```
Authorization: Bearer {accessToken}
```

**R√©ponse :**
```json
{
  "user": {
    "id": "uuid",
    "email": "john@example.com",
    "authProvider": "email",
    "emailVerified": false,
    "createdAt": "2025-08-28T...",
    "updatedAt": "2025-08-28T..."
  }
}
```

### ‚öΩ Donn√©es de football

#### `GET /api/v1/fixtures`
Liste des matchs avec filtrage par date.

**Param√®tres :**
- `date` (optionnel) : Format YYYY-MM-DD

**Exemple :**
```bash
GET /api/v1/fixtures?date=2025-08-28
```

**R√©ponse :**
```json
[
  {
    "id": "1448216",
    "startTime": "2025-08-28T20:00:00+00:00",
    "status": "NS",
    "minute": null,
    "phase": "NOT_STARTED",
    "league": {
      "id": "39",
      "name": "Premier League",
      "country": "England"
    },
    "homeTeam": {
      "id": "50",
      "name": "Manchester City",
      "shortName": "MCI",
      "logoUrl": "https://..."
    },
    "awayTeam": {
      "id": "33",
      "name": "Manchester United",
      "shortName": "MUN",
      "logoUrl": "https://..."
    },
    "score": {
      "home": null,
      "away": null
    },
    "venue": {
      "id": "555",
      "name": "Etihad Stadium",
      "city": "Manchester"
    }
  }
]
```

#### `GET /api/v1/fixtures/live`
Matchs en cours en temps r√©el.

#### `GET /api/v1/matches/{id}`
D√©tails d'un match sp√©cifique avec statistiques.

### üë• Syst√®me de follows

#### `POST /api/v1/follows`
Suivre une √©quipe, ligue ou match (authentification requise).

**Body :**
```json
{
  "entityType": "team",
  "entityId": "50",
  "notificationPreferences": {
    "goals": true,
    "cards": false,
    "substitutions": false,
    "matchStart": true,
    "matchEnd": true,
    "lineups": false
  }
}
```

**R√©ponse :**
```json
{
  "message": "Successfully followed team",
  "follow": {
    "id": "uuid",
    "userId": "user_uuid",
    "entityType": "team",
    "entityId": "50",
    "isActive": true,
    "notificationPreferences": {...},
    "createdAt": "2025-08-28T..."
  }
}
```

#### `GET /api/v1/follows`
Liste des entit√©s suivies par l'utilisateur (authentification requise).

**R√©ponse :**
```json
{
  "follows": [
    {
      "id": "uuid",
      "entityType": "team",
      "entityId": "50",
      "isActive": true,
      "notificationPreferences": {...}
    }
  ],
  "pagination": {
    "total": 1,
    "perPage": 20,
    "currentPage": 1,
    "lastPage": 1
  }
}
```

#### `DELETE /api/v1/follows`
Ne plus suivre une entit√© (authentification requise).

**Body :**
```json
{
  "entityType": "team",
  "entityId": "50"
}
```

---

## üóÑÔ∏è Base de donn√©es

### Sch√©ma PostgreSQL

#### Table `users`
```sql
CREATE TABLE users (
  id VARCHAR(255) PRIMARY KEY,
  full_name VARCHAR(255),
  email VARCHAR(254) UNIQUE,
  password VARCHAR(255),
  account_status VARCHAR(50) DEFAULT 'active',
  auth_provider VARCHAR(50) DEFAULT 'local',
  email_verified BOOLEAN DEFAULT FALSE,
  is_admin BOOLEAN DEFAULT FALSE,
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### Table `teams`
```sql
CREATE TABLE teams (
  id VARCHAR(255) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  short_name VARCHAR(50),
  logo_url VARCHAR(500),
  league_id VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (league_id) REFERENCES leagues(id)
);
```

#### Table `follows`
```sql
CREATE TABLE follows (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR(255),
  entity_type VARCHAR(50), -- 'team', 'league', 'match'
  entity_id VARCHAR(255),
  is_active BOOLEAN DEFAULT TRUE,
  notification_preferences JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### Migrations
```bash
# Ex√©cuter toutes les migrations
node ace migration:run

# Rollback de la derni√®re migration
node ace migration:rollback

# Statut des migrations
node ace migration:status
```

---

## üöÄ D√©ploiement en production

### Railway (Recommand√©)

#### 1. Configuration Railway
```bash
# Installer Railway CLI
npm install -g @railway/cli

# Se connecter √† Railway
railway login

# Lier le projet
railway link
```

#### 2. Variables d'environnement Railway
Configurer ces variables dans le dashboard Railway :

```env
NODE_ENV=production
PORT=3333
HOST=0.0.0.0
LOG_LEVEL=warn

APP_KEY=production_app_key_32_chars
JWT_SECRET=production_jwt_secret_32_chars
JWT_EXPIRES_IN=24h
REFRESH_TOKEN_EXPIRES_IN=7d

DATABASE_URL=${Postgres.DATABASE_URL}
DB_CONNECTION=postgres

RAPIDAPI_KEY=votre_cl√©_production
RAPIDAPI_HOST=api-football-v1.p.rapidapi.com
AF_SEASON=2025
AF_LEAGUE_SLUGS=39,140,78,135,61

MOCK_API=false
SESSION_DRIVER=cookie
TZ=UTC
```

#### 3. D√©ploiement
```bash
# D√©ployer sur Railway
git push origin main

# Ou d√©ploiement manuel
railway up
```

#### 4. Migrations en production
```bash
# Ex√©cuter les migrations sur Railway
railway run node ace migration:run --force
```

### Configuration PostgreSQL Railway
1. Ajouter un service PostgreSQL dans Railway
2. Connecter la base de donn√©es au service backend
3. La variable `DATABASE_URL` sera automatiquement g√©n√©r√©e

---

## üß™ Tests et validation

### Tests manuels des endpoints

#### 1. Test de sant√©
```bash
curl https://mythayun-backend-production.up.railway.app/health
```

#### 2. Test d'inscription
```bash
curl -X POST "https://mythayun-backend-production.up.railway.app/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "fullName": "Test User",
    "email": "test@example.com",
    "password": "testpassword123"
  }'
```

#### 3. Test de connexion
```bash
curl -X POST "https://mythayun-backend-production.up.railway.app/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "testpassword123"
  }'
```

#### 4. Test des matchs
```bash
curl "https://mythayun-backend-production.up.railway.app/api/v1/fixtures?date=2025-08-28"
```

#### 5. Test des follows (avec token)
```bash
curl -X POST "https://mythayun-backend-production.up.railway.app/api/v1/follows" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "entityType": "team",
    "entityId": "50"
  }'
```

### Validation des r√©ponses
- **Status 200** : Succ√®s
- **Status 401** : Non authentifi√©
- **Status 422** : Erreur de validation
- **Status 500** : Erreur serveur

---

## üìä Maintenance et monitoring

### Logs Railway
```bash
# Voir les logs en temps r√©el
railway logs

# Logs avec filtre
railway logs --filter error
```

### Monitoring de sant√©
- **URL** : `https://mythayun-backend-production.up.railway.app/health`
- **Fr√©quence recommand√©e** : Toutes les 5 minutes
- **Alertes** : Si `status !== "ok"` ou `footballApi !== "healthy"`

### Base de donn√©es
```bash
# Se connecter √† PostgreSQL Railway
railway connect postgres

# V√©rifier les tables
\dt

# Statistiques utilisateurs
SELECT COUNT(*) FROM users;

# Statistiques follows
SELECT entity_type, COUNT(*) FROM follows GROUP BY entity_type;
```

### Sauvegarde
Railway effectue des sauvegardes automatiques de PostgreSQL. Pour des sauvegardes manuelles :

```bash
# Export de la base de donn√©es
railway run pg_dump $DATABASE_URL > backup.sql
```

---

## üîß D√©pannage

### Probl√®mes courants

#### 1. Erreur de connexion √† la base de donn√©es
```bash
# V√©rifier les variables d'environnement
railway variables

# Tester la connexion
railway run node ace migration:status
```

#### 2. API Football non accessible
- V√©rifier la cl√© `RAPIDAPI_KEY`
- V√©rifier les quotas sur RapidAPI
- Tester manuellement l'API Football

#### 3. Erreurs JWT
- V√©rifier `JWT_SECRET` en production
- V√©rifier la coh√©rence des secrets entre environnements

#### 4. Probl√®mes de CORS
- V√©rifier la configuration CORS dans `config/cors.ts`
- Ajouter les domaines frontend autoris√©s

### Support
- **Repository** : [MythaYun/mythayun-backend](https://github.com/MythaYun/mythayun-backend)
- **Issues** : Cr√©er une issue sur GitHub
- **Documentation AdonisJS** : [docs.adonisjs.com](https://docs.adonisjs.com)

---

## üìù Changelog

### Version 1.0.0 (Ao√ªt 2025)
- ‚úÖ API d'authentification compl√®te
- ‚úÖ Int√©gration API Football temps r√©el
- ‚úÖ Syst√®me de follows avanc√©
- ‚úÖ D√©ploiement Railway production
- ‚úÖ Base de donn√©es PostgreSQL
- ‚úÖ Documentation compl√®te

### Fonctionnalit√©s √† venir
- üîÑ Notifications push
- üîÑ Cache Redis pour les performances
- üîÑ Tests automatis√©s
- üîÑ Analytics et m√©triques
- üîÑ Authentification sociale (Google, Facebook)

---

*Documentation mise √† jour le 28 ao√ªt 2025*
*Version du backend : 1.0.0*
*Environnement : Production Railway*
